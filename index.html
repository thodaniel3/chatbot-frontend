<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MME Department Chatbot</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>MME Department Chatbot</h1>
  <p class="subtitle">Ask questions based on departmental materials eg course title, MME 412, keywords eg gold, forging,etc </p>
  <p class="subtitle">This is MME departmental chatbots, Customized for the department. all results and answers, are from Authentic sources eg lecturer's Handouts, pdfs, research journals etc. Enjoy the Benefits.</p>

  <input type="text" id="question" placeholder="Type your question here">
  <button onclick="askQuestion()">Ask</button>

  <div id="answer"></div>

  <hr>

  <button class="admin-btn" onclick="window.location.href='admin.html'">
    Admin Login
  </button>
</div>

<script>
const backendUrl = "https://chatbot-backend-2nxq.onrender.com";

/* =============================
   FORMAT ANSWER TEXT (READABLE)
============================= */
function formatAnswerText(text) {
  if (!text) return "";

  // Escape HTML (security)
  let safeText = text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  // Numbered headings (e.g. 1. Basic Description)
  safeText = safeText.replace(
    /(^|\n)(\d+\.\s+[A-Z][^\n]+)/g,
    '<h3>$2</h3>'
  );

  // Subheadings (ending with :)
  safeText = safeText.replace(
    /([A-Z][A-Za-z\s]+:)/g,
    '<h4>$1</h4>'
  );

  // Split into paragraphs
  safeText = safeText
    .split(/\n{2,}/)
    .map(p => `<p>${p.trim()}</p>`)
    .join("");

  return safeText;
}

/* =============================
   ASK QUESTION
============================= */
async function askQuestion() {
  const question = document.getElementById("question").value.trim();
  if (!question) return alert("Please type a question.");

  const res = await fetch(`${backendUrl}/ask`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question })
  });

  const data = await res.json();
  const answerDiv = document.getElementById("answer");
  answerDiv.innerHTML = "";

  if (!data.matches || data.matches.length === 0) {
    answerDiv.innerHTML = "<p><b>No answer found.</b></p>";
    return;
  }

  // Show ONLY the best answer (clean UI)
  const m = data.matches[0];

  answerDiv.innerHTML = `
    <div class="card">
      <div class="card-title">Answer</div>
      <div class="card-meta"><b>Lecturer:</b> ${m.lecturer || "Unknown"}</div>
      <div class="card-meta"><b>Source:</b> ${m.source || "Unknown"}</div>

      <div class="answer-text">
        ${formatAnswerText(m.snippet)}
      </div>

      ${m.file_url ? `<a class="file-link" href="${m.file_url}" target="_blank">Open File</a>` : ""}
    </div>
  `;
}
</script>

</body>
</html>
